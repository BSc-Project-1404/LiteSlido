{% extends 'base.html' %}
{% block title %}{{ poll.question }} — LiteSlido{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
  <!-- Header -->
  <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-2">{{ poll.question }}</h1>
    <p class="text-gray-600">Event: <span class="font-semibold">{{ event.title }}</span></p>
  </div>

  {% if user_has_voted %}
    <!-- Results Section -->
    <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Poll Results</h2>
      
      <!-- Chart Container -->
      <div class="mb-8 bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 shadow-lg border border-blue-100">
        <div class="text-center mb-6">
          <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 rounded-full mb-3">
            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
          </div>
          <h3 class="text-xl font-bold text-gray-800 mb-2">Vote Distribution</h3>
          <p class="text-sm text-gray-600">Visual representation of poll results</p>
        </div>
        
        <!-- Chart with enhanced styling -->
        <div class="relative bg-white rounded-lg p-4 shadow-inner" style="height: 320px;">
          <canvas id="resultsChart" style="max-width: 100%; height: 100%;"></canvas>
          
          <!-- Loading animation -->
          <div id="chartFallback" class="absolute inset-0 flex items-center justify-center bg-white bg-opacity-90 rounded-lg">
            <div class="text-center">
              <div class="inline-flex items-center justify-center w-12 h-12 bg-blue-100 rounded-full mb-3 animate-pulse">
                <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
                </svg>
              </div>
              <p class="text-gray-600 font-medium">Loading chart...</p>
            </div>
          </div>
        </div>
        
        <!-- Chart legend and stats -->
        <div class="mt-4 grid grid-cols-2 gap-4">
          <div class="text-center p-3 bg-white rounded-lg shadow-sm">
            <div class="text-2xl font-bold text-blue-600">
              {{ option_votes_list|length }}
            </div>
            <div class="text-sm text-gray-600">Total Options</div>
          </div>
          <div class="text-center p-3 bg-white rounded-lg shadow-sm">
            <div class="text-2xl font-bold text-green-600">
              {% widthratio option_votes_list|length 1 1 %}
            </div>
            <div class="text-sm text-gray-600">Total Votes</div>
          </div>
        </div>
      </div>

      <!-- Results List -->
      <div class="space-y-4">
        {% for option, votes in option_votes_list %}
          <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
            <span class="text-gray-800 font-medium">{{ option.text }}</span>
            <div class="flex items-center space-x-2">
              <span class="text-gray-600">{{ votes }} vote{% if votes != 1 %}s{% endif %}</span>
              {% if option_votes_list|length > 0 %}
                {% widthratio votes option_votes_list|length 100 as percentage %}
                <span class="text-sm text-gray-500">({{ percentage }}%)</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

  {% else %}
    <!-- Voting Section -->
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h2 class="text-2xl font-bold text-gray-800 mb-6">Cast Your Vote</h2>
      
      <form method="post" class="space-y-4">
        {% csrf_token %}
        {% for option, votes in option_votes_list %}
          <div class="flex items-center p-4 border border-gray-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all duration-200">
            <input type="radio"
                   name="poll_option"
                   id="opt{{ option.id }}"
                   value="{{ option.id }}"
                   class="h-5 w-5 text-blue-600 focus:ring-blue-500 border-gray-300"
                   required>
            <label for="opt{{ option.id }}" class="ml-3 flex-1 cursor-pointer">
              <span class="text-gray-800 font-medium">{{ option.text }}</span>
            </label>
          </div>
        {% endfor %}
        
        <button type="submit"
                class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-all duration-200 font-medium text-lg">
          Submit Vote
        </button>
      </form>
    </div>
  {% endif %}

  <!-- Navigation -->
  <div class="mt-8 text-center">
    <a href="{% url 'event_detail' event_code=event.code %}"
       class="text-sm text-gray-600 hover:text-gray-800 hover:underline transition-colors duration-200">
      ← Back to Event
    </a>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
  {% if user_has_voted %}
    <!-- Load Chart.js with error handling -->
    <script>
      // Prevent multiple executions
      if (window.pollChartInitialized) {
        console.log('Chart already initialized, skipping...');
        exit;
      }
      window.pollChartInitialized = true;
      
      console.log('=== CHART SCRIPT LOADED ===');
      console.log('User has voted:', true);
      console.log('DOM ready state:', document.readyState);
      
      // Global chart variable
      let pollChart = null;
      
      // Function to load Chart.js dynamically
      function loadChartJS() {
        return new Promise((resolve, reject) => {
          // Check if already loaded
          if (typeof Chart !== 'undefined') {
            resolve();
            return;
          }
          
          console.log('Loading Chart.js...');
          
          // Create script element
          const script = document.createElement('script');
          script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';
          script.onload = () => {
            console.log('Chart.js loaded successfully');
            resolve();
          };
          script.onerror = () => {
            console.error('Failed to load Chart.js');
            reject(new Error('Chart.js failed to load'));
          };
          
          // Add to head
          document.head.appendChild(script);
        });
      }
      
      // Main chart initialization function
      async function initChart() {
        try {
          console.log('Starting chart initialization...');
          
          const canvas = document.getElementById('resultsChart');
          const fallback = document.getElementById('chartFallback');
          
          if (!canvas) {
            console.error('Canvas element not found');
            fallback.innerHTML = '<p class="text-red-500">Canvas element not found</p>';
            return;
          }
          
          console.log('Canvas found, loading Chart.js...');
          
          // Load Chart.js
          await loadChartJS();
          
          console.log('Chart.js loaded, checking availability...');
          
          if (typeof Chart === 'undefined') {
            throw new Error('Chart.js still not available after loading');
          }
          
          console.log('Chart.js is available, creating chart...');
          
          // Get the 2D context
          const ctx = canvas.getContext('2d');
          if (!ctx) {
            throw new Error('Could not get 2D context from canvas');
          }
          
          console.log('2D context obtained, preparing data...');
          
          // Prepare chart data
          const labels = [
            {% for option, votes in option_votes_list %}
              "{{ option.text|escapejs }}"{% if not forloop.last %}, {% endif %}
            {% endfor %}
          ];
          
          const data = [
            {% for option, votes in option_votes_list %}
              {{ votes }}{% if not forloop.last %}, {% endif %}
            {% endfor %}
          ];
          
          console.log('Chart data prepared:', { labels, data });
          
          // Create chart with enhanced styling
          pollChart = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: labels,
              datasets: [{
                label: 'Votes',
                data: data,
                backgroundColor: [
                  'rgba(59, 130, 246, 0.9)',   // Blue
                  'rgba(16, 185, 129, 0.9)',   // Green
                  'rgba(245, 158, 11, 0.9)',   // Yellow
                  'rgba(239, 68, 68, 0.9)',    // Red
                  'rgba(139, 92, 246, 0.9)',   // Purple
                  'rgba(236, 72, 153, 0.9)',   // Pink
                ],
                borderColor: [
                  'rgba(59, 130, 246, 1)',
                  'rgba(16, 185, 129, 1)',
                  'rgba(245, 158, 11, 1)',
                  'rgba(239, 68, 68, 1)',
                  'rgba(139, 92, 246, 1)',
                  'rgba(236, 72, 153, 1)',
                ],
                borderWidth: 3,
                borderRadius: 8,
                barPercentage: 0.7,
                categoryPercentage: 0.9,
                hoverBackgroundColor: [
                  'rgba(59, 130, 246, 1)',
                  'rgba(16, 185, 129, 1)',
                  'rgba(245, 158, 11, 1)',
                  'rgba(239, 68, 68, 1)',
                  'rgba(139, 92, 246, 1)',
                  'rgba(236, 72, 153, 1)',
                ],
                hoverBorderColor: [
                  'rgba(59, 130, 246, 1)',
                  'rgba(16, 185, 129, 1)',
                  'rgba(245, 158, 11, 1)',
                  'rgba(239, 68, 68, 1)',
                  'rgba(139, 92, 246, 1)',
                  'rgba(236, 72, 153, 1)',
                ],
                hoverBorderWidth: 4,
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              animation: {
                duration: 1500,
                easing: 'easeOutQuart'
              },
              layout: {
                padding: {
                  top: 25,
                  right: 25,
                  bottom: 25,
                  left: 25
                }
              },
              plugins: {
                legend: { 
                  display: false 
                },
                tooltip: {
                  backgroundColor: 'rgba(17, 24, 39, 0.98)',
                  titleColor: '#F9FAFB',
                  bodyColor: '#F9FAFB',
                  padding: 16,
                  cornerRadius: 12,
                  borderColor: 'rgba(59, 130, 246, 0.3)',
                  borderWidth: 2,
                  titleFont: {
                    size: 14,
                    weight: '600'
                  },
                  bodyFont: {
                    size: 13
                  },
                  callbacks: {
                    label: function(context) {
                      const total = context.dataset.data.reduce((a, b) => a + b, 0);
                      const percentage = total > 0 ? Math.round((context.parsed.y / total) * 100) : 0;
                      return `${context.parsed.y} vote${context.parsed.y !== 1 ? 's' : ''} (${percentage}%)`;
                    }
                  }
                }
              },
              scales: {
                x: {
                  grid: {
                    display: false
                  },
                  ticks: {
                    color: '#374151',
                    font: { 
                      size: 13,
                      weight: '600'
                    },
                    maxRotation: 45,
                    padding: 8
                  }
                },
                y: {
                  beginAtZero: true,
                  grid: {
                    color: 'rgba(203, 213, 225, 0.3)',
                    lineWidth: 1
                  },
                  ticks: {
                    precision: 0,
                    color: '#6B7280',
                    font: { 
                      size: 12,
                      weight: '500'
                    },
                    padding: 10,
                    maxTicksLimit: 8
                  },
                  suggestedMax: function(context) {
                    const max = Math.max(...context.chart.data.datasets[0].data);
                    return max > 0 ? Math.ceil(max * 1.3) : 5;
                  }
                }
              },
              interaction: {
                intersect: false,
                mode: 'index'
              }
            }
          });
          
          console.log('Chart created successfully!');
          
          // Hide fallback and show canvas
          fallback.style.display = 'none';
          canvas.style.display = 'block';
          
        } catch (error) {
          console.error('Error in chart initialization:', error);
          const fallback = document.getElementById('chartFallback');
          fallback.innerHTML = '<p class="text-red-500">Chart Error: ' + error.message + '</p>';
          
          // Hide canvas on error
          const canvas = document.getElementById('resultsChart');
          if (canvas) {
            canvas.style.display = 'none';
          }
        }
      }
      
      // Start initialization only once
      console.log('Script loaded, DOM ready state:', document.readyState);
      
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initChart, { once: true });
        console.log('Added DOMContentLoaded listener (once)');
      } else {
        console.log('DOM already ready, starting immediately');
        initChart();
      }
    </script>
  {% endif %}
{% endblock %}
